# /etc/nginx/sites-available/teams-bot

# IP Whitelist für Microsoft Bot Service
geo $bot_allowed {
    default 0;
    
    # Lokaler Zugriff für Health Checks
    127.0.0.1 1;
    ::1 1;
    
    # Microsoft Bot Service IPs (IPv4)
    102.133.124.8/30 1;
    102.133.216.64/30 1;
    102.133.28.88/30 1;
    102.133.56.64/30 1;
    13.66.142.64/30 1;
    13.67.10.88/30 1;
    13.69.227.252/30 1;
    13.69.67.56/30 1;
    13.70.74.112/30 1;
    13.71.173.240/30 1;
    13.71.196.160/30 1;
    13.73.248.0/30 1;
    13.75.39.72/30 1;
    13.77.53.80/30 1;
    13.78.108.172/30 1;
    13.86.219.168/30 1;
    13.87.124.40/30 1;
    13.87.58.40/30 1;
    13.89.171.116/30 1;
    134.138.64.16/30 1;
    158.23.96.16/30 1;
    172.204.152.16/30 1;
    191.233.205.96/30 1;
    191.233.8.16/30 1;
    191.235.224.64/30 1;
    20.150.160.120/30 1;
    20.17.112.16/30 1;
    20.17.48.16/30 1;
    20.189.104.64/30 1;
    20.192.160.16/30 1;
    20.192.224.64/26 1;
    20.21.32.16/30 1;
    20.215.0.16/30 1;
    20.217.248.16/30 1;
    20.217.40.16/30 1;
    20.36.108.112/30 1;
    20.36.115.240/30 1;
    20.36.120.64/30 1;
    20.37.152.64/30 1;
    20.37.192.64/30 1;
    20.37.224.64/30 1;
    20.37.64.64/30 1;
    20.37.76.104/30 1;
    20.38.128.72/30 1;
    20.38.136.64/30 1;
    20.38.80.64/30 1;
    20.39.8.64/30 1;
    20.41.0.64/30 1;
    20.41.192.64/30 1;
    20.41.64.64/30 1;
    20.42.0.64/30 1;
    20.42.128.64/30 1;
    20.42.224.64/30 1;
    20.43.121.8/30 1;
    20.43.128.64/30 1;
    20.43.40.64/30 1;
    20.43.64.64/30 1;
    20.44.17.24/30 1;
    20.44.27.208/30 1;
    20.44.4.72/30 1;
    20.45.112.64/30 1;
    20.45.123.112/30 1;
    20.45.192.64/30 1;
    20.72.16.16/30 1;
    4.232.24.16/30 1;
    40.67.48.64/30 1;
    40.67.58.4/30 1;
    40.69.108.56/30 1;
    40.71.12.244/30 1;
    40.74.147.168/30 1;
    40.74.24.64/30 1;
    40.78.196.56/30 1;
    40.78.202.132/30 1;
    40.79.132.56/30 1;
    40.79.180.24/30 1;
    40.80.168.64/30 1;
    40.80.176.32/30 1;
    40.80.184.64/30 1;
    40.80.56.64/30 1;
    40.82.248.64/30 1;
    40.89.16.64/30 1;
    48.216.16.16/30 1;
    48.219.192.16/30 1;
    51.104.24.64/30 1;
    51.104.8.248/30 1;
    51.105.80.64/30 1;
    51.105.88.64/30 1;
    51.107.144.64/30 1;
    51.107.154.4/30 1;
    51.107.48.64/30 1;
    51.107.58.4/30 1;
    51.116.144.64/30 1;
    51.116.48.64/30 1;
    51.12.192.64/26 1;
    51.12.40.64/26 1;
    51.120.218.4/30 1;
    51.120.224.64/30 1;
    51.120.40.64/30 1;
    51.120.98.12/30 1;
    51.137.160.64/30 1;
    51.140.212.72/30 1;
    51.143.192.64/30 1;
    51.53.168.16/30 1;
    51.53.24.16/30 1;
    52.136.48.64/30 1;
    52.140.104.64/30 1;
    52.150.136.64/30 1;
    52.162.111.16/30 1;
    52.228.80.64/30 1;
    52.231.148.88/30 1;
    57.151.208.16/30 1;
    65.52.252.104/30 1;
    68.210.160.16/30 1;
    68.211.18.148/30 1;
    68.221.80.16/30 1;
    70.153.152.16/30 1;
    74.7.176.16/30 1;
    74.7.40.16/30 1;
    9.160.40.16/30 1;
    9.205.32.16/30 1;
    
    # Microsoft Bot Service IPs (IPv6)
    2603:1000:104:1::20/123 1;
    2603:1000:4::20/123 1;
    2603:1010:101::20/123 1;
    2603:1010:304::20/123 1;
    2603:1010:404::20/123 1;
    2603:1010:502::20/123 1;
    2603:1010:6:1::20/123 1;
    2603:1020:1004::20/123 1;
    2603:1020:104:3::6c0/123 1;
    2603:1020:1104::20/123 1;
    2603:1020:1204::20/123 1;
    2603:1020:1302::20/123 1;
    2603:1020:1403::20/123 1;
    2603:1020:1502::20/123 1;
    2603:1020:1602::20/123 1;
    2603:1020:206:1::20/123 1;
    2603:1020:305::20/123 1;
    2603:1020:405::20/123 1;
    2603:1020:5:1::20/123 1;
    2603:1020:605::20/123 1;
    2603:1020:705:1::20/123 1;
    2603:1020:805:1::20/123 1;
    2603:1020:905::20/123 1;
    2603:1020:a04:1::20/123 1;
    2603:1020:b04::20/123 1;
    2603:1020:c04:1::20/123 1;
    2603:1020:d04::20/123 1;
    2603:1020:e04:1::20/123 1;
    2603:1020:f04::20/123 1;
    2603:1030:10:1::20/123 1;
    2603:1030:1005::20/123 1;
    2603:1030:104:1::20/123 1;
    2603:1030:107::20/123 1;
    2603:1030:1102::20/123 1;
    2603:1030:1202::20/123 1;
    2603:1030:1302::20/123 1;
    2603:1030:1402::20/123 1;
    2603:1030:1502::20/123 1;
    2603:1030:210:1::20/123 1;
    2603:1030:40b:1::20/123 1;
    2603:1030:40c:1::20/123 1;
    2603:1030:504:1::20/123 1;
    2603:1030:608::20/123 1;
    2603:1030:702::20/123 1;
    2603:1030:807:1::20/123 1;
    2603:1030:902::20/123 1;
    2603:1030:a07::20/123 1;
    2603:1030:b04::20/123 1;
    2603:1030:c06:1::20/123 1;
    2603:1030:f:1::20/123 1;
    2603:1030:f05:1::20/123 1;
    2603:1040:1002::60/123 1;
    2603:1040:1104::20/123 1;
    2603:1040:1202::20/123 1;
    2603:1040:1302::20/123 1;
    2603:1040:1402::20/123 1;
    2603:1040:1503::20/123 1;
    2603:1040:1602::20/123 1;
    2603:1040:1702::20/123 1;
    2603:1040:1802:2::740/123 1;
    2603:1040:207::20/123 1;
    2603:1040:407:1::20/123 1;
    2603:1040:5:1::20/123 1;
    2603:1040:606::20/123 1;
    2603:1040:806::20/123 1;
    2603:1040:904:1::20/123 1;
    2603:1040:a06:1::20/123 1;
    2603:1040:b04::20/123 1;
    2603:1040:c06::20/123 1;
    2603:1040:d04::20/123 1;
    2603:1040:e05:1::540/123 1;
    2603:1040:f05:1::20/123 1;
    2603:1050:301::20/123 1;
    2603:1050:403::20/123 1;
    2603:1050:6:1::20/123 1;
}

# HTTP Server - Redirect zu HTTPS
server {
    listen 80;
    server_name b1.ifp-service.de;
    
    # Let's Encrypt Validierung
    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }
    
    # Alles andere zu HTTPS umleiten
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS Server - Der eigentliche Bot
server {
    listen 443 ssl http2;
    server_name b1.ifp-service.de;
    
    # SSL Zertifikate
    ssl_certificate /etc/letsencrypt/live/b1.ifp-service.de/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/b1.ifp-service.de/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    
    # Logging mit IP für Sicherheit
    access_log /var/log/nginx/teams-bot-access.log;
    error_log /var/log/nginx/teams-bot-error.log;
    
    # Bot API Endpoint - NUR für erlaubte IPs
    location /api/messages {
        # IP Check
        if ($bot_allowed = 0) {
            return 403 "Access denied. This endpoint is only accessible from Microsoft Bot Service IPs.";
        }
        
        proxy_pass http://127.0.0.1:3978/api/messages;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        
        # Authorization Header durchreichen
        proxy_set_header Authorization $http_authorization;
        
        # Timeouts für Bot-Antworten
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Body size für potentielle Attachments
        client_max_body_size 10M;
    }
    
    # Health Check - nur lokal erreichbar
    location /health {
        # Nur localhost
        allow 127.0.0.1;
        allow ::1;
        deny all;
        
        proxy_pass http://127.0.0.1:3978/health;
        proxy_http_version 1.1;
        
        # Kein Logging für Health Checks
        access_log off;
    }
    
    # Root - 403 für alles andere
    location / {
        return 403 "Access denied";
    }
    
    # Security Headers
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
}